{% extends "layout.njk" %}

{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "pages/appointments/partials/appointment-type-caption.njk" import appointmentTypeCaption %}
{% from "pages/appointments/partials/appointment-journey-title.njk" import appointmentJourneyTitle %}
{% from "partials/appointmentPrisonerSummary.njk" import appointmentPrisonerSummary %}

{% if session.appointmentJourney.type == AppointmentType.BULK %}
    {% set pageTitle = appointmentJourneyTitle("No attendees for set" if prisoners.length == 0 else "Avoid clashes", session.appointmentJourney) %}
{% else %}
    {% set pageTitle = appointmentJourneyTitle("No attendees" if prisoners.length == 0 else "Avoid clashes", session.appointmentJourney) %}
{% endif %}
{% set pageId = 'appointments-schedule-page' %}
{% set backLinkHref = backLinkHref %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            {{ appointmentTypeCaption(session) }}

            {% if prisonerSchedules.length == 0 %}
                {% if session.appointmentJourney.type == AppointmentType.BULK %}
                    <h1 class="govuk-heading-l">There are no attendees for this set</h1>
                    <p class="govuk-body">You’ve removed the last attendee for this set of appointments.</p>
                    <p class="govuk-body">You need to add a new list of prison numbers to continue scheduling the set of back-to-backs.</p>
                {% else %}
                    <h1 class="govuk-heading-l">There are no attendees for this appointment</h1>
                    <p class="govuk-body">You’ve removed the last attendee for this appointment.</p>
                    <p class="govuk-body">You need to add someone to continue scheduling it.</p>
                {% endif %}

                {% set addPrisonersHref = ('prisoners/add/how-to-add-prisoners?preserveHistory=true' if session.appointmentJourney.mode == AppointmentJourneyMode.EDIT) or
                    ("upload-bulk-appointment?preserveHistory=true" if session.appointmentJourney.type == AppointmentType.BULK) or
                    "how-to-add-prisoners?preserveHistory=true" %}

                {{ govukButton({
                    text: ("Add a new list" if session.appointmentJourney.type == AppointmentType.BULK else "Add someone to the list"),
                    href: addPrisonersHref
                }) }}
            {% else %}
                <h1 class="govuk-heading-l">Review scheduled events to avoid clashes</h1>

                <form method="POST">
                    <input type="hidden" name="_csrf" value="{{ csrfToken }}" />

                    {% set appointmentSummary = [] %}
                    {% if session.appointmentJourney.mode != AppointmentJourneyMode.EDIT %}
                        {% set appointmentSummary = (appointmentSummary.push(
                            {
                                key: {
                                    text: "Appointment name"
                                },
                                value: {
                                    text: session.appointmentJourney.appointmentName
                                }
                            }, {
                                key: {
                                    text: "Attendee"
                                },
                                value: {
                                    html: appointmentPrisonerSummary(
                                        session.appointmentJourney.prisoners[0].name,
                                        session.appointmentJourney.prisoners[0].number,
                                        session.appointmentJourney.prisoners[0].cellLocation,
                                        dpsUrl
                                    )
                                },
                                actions: {
                                    items: [
                                        {
                                            href: "change?property=select-prisoner&preserveHistory=true",
                                            text: "Change",
                                            visuallyHiddenText: "change attendee",
                                            classes: "govuk-link--no-visited-state",
                                            attributes: { 'data-qa': 'change-prisoner' }
                                        }
                                    ]
                                }
                            } if session.appointmentJourney.type == AppointmentType.INDIVIDUAL, {
                                key: {
                                    text: "Attendees"
                                },
                                value: {
                                    text: session.appointmentJourney.prisoners | length
                                },
                                actions: {
                                    items: [
                                        {
                                            href: "change?property=review-prisoners&preserveHistory=true",
                                            text: "Change",
                                            visuallyHiddenText: "change prisoners",
                                            classes: "govuk-link--no-visited-state",
                                            attributes: { 'data-qa': 'change-prisoners' }
                                        }
                                    ]
                                }
                            } if session.appointmentJourney.type == AppointmentType.GROUP, {
                                key: {
                                    text: "Appointments"
                                },
                                value: {
                                    text: session.bulkAppointmentJourney.appointments | length
                                }
                            } if session.appointmentJourney.type == AppointmentType.BULK
                        ), appointmentSummary) %}
                    {% endif %}

                    {% if session.editAppointmentJourney.addPrisoners | length %}
                        {% set appointmentSummary = (appointmentSummary.push({
                            key: {
                                text: "Attendees you are adding"
                            },
                            value: {
                                text: session.editAppointmentJourney.addPrisoners | length
                            },
                            actions: {
                                items: [
                                    {
                                        href: 'prisoners/add/review-prisoners',
                                        text: "Change",
                                        visuallyHiddenText: "change attendees",
                                        classes: "govuk-link--no-visited-state",
                                        attributes: { 'data-qa': 'change-attendees' }
                                    }
                                ]
                            }
                        }), appointmentSummary) %}
                    {% endif %}

                    {% set showTime = (session.appointmentJourney.startTime and session.appointmentJourney.endTime) or
                        (session.editAppointmentJourney.startTime and session.editAppointmentJourney.endTime) %}

                    {% set isDateTimeEditable = session.appointmentJourney.mode != AppointmentJourneyMode.EDIT or
                        session.editAppointmentJourney.startDate or
                        (session.editAppointmentJourney.startTime and session.editAppointmentJourney.endTime) %}
                    {% set appointmentSummary = (appointmentSummary.push(
                        {
                            key: {
                                text: "Date"
                            },
                            value: {
                                text: appointmentDate()
                            },
                            actions: {
                                items: [
                                    {
                                        href: 'change?property=bulk-appointment-date&preserveHistory=true' if session.appointmentJourney.type == AppointmentType.BULK else 'change?property=date-and-time&preserveHistory=true',
                                        text: "Change",
                                        visuallyHiddenText: "change date",
                                        classes: "govuk-link--no-visited-state",
                                        attributes: { 'data-qa': 'change-start-date' }
                                    }
                                ]
                            } if isDateTimeEditable
                        }, {
                            key: {
                                text: "Time"
                            },
                            value: {
                                text: appointmentTime()
                            },
                            actions: {
                                items: [
                                    {
                                        href: "change?property=date-and-time&preserveHistory=true",
                                        text: "Change",
                                        visuallyHiddenText: "change time",
                                        classes: "govuk-link--no-visited-state",
                                        attributes: { 'data-qa': 'change-time' }
                                    }
                                ]
                            } if isDateTimeEditable
                        } if showTime
                    ), appointmentSummary) %}
                    {{ govukSummaryList({
                        rows: appointmentSummary,
                        attributes: { 'data-qa': 'appointment-details' }
                    }) }}

                    {{ govukButton({
                        text: getAppointmentEditApplyToCta(session.appointmentJourney, session.editAppointmentJourney) if isCtaAcceptAndSave else "Continue",
                        attributes: { 'data-qa': 'top-cta' }
                    }) if prisonerSchedules.length > 10 }}

                    {% if session.appointmentJourney.type != AppointmentType.INDIVIDUAL %}
                        <h2 class="govuk-heading-m" data-qa="schedules-heading">Attendee events on {{ appointmentDate() }}</h2>
                    {% endif %}

                    {% for prisonerSchedule in prisonerSchedules %}
                        {% set prisoner = prisonerSchedule.prisoner %}
                        {% if session.appointmentJourney.type == AppointmentType.INDIVIDUAL %}
                            <h2 class="govuk-heading-m" data-qa="schedule-heading">Events for {{ prisoner.name | toTitleCase if prisoner.name else "No matching name" }}, {{ prisoner.number }} on {{ session.appointmentJourney.startDate.date | parseISODate | formatDate('EEEE, d MMMM yyyy') }}</h2>
                            {{ prisonerScheduledEvents(prisoner, prisonerSchedule.scheduledEvents) }}
                        {% else %}
                            <div class="govuk-summary-card appointment-schedule">
                                <div class="govuk-summary-card__title-wrapper">
                                    <h2 class="govuk-summary-card__title" data-qa="schedule-card-title-prison-number-{{ prisoner.number }}">
                                        <ul class='govuk-list'>
                                            <li><strong>{{ prisoner.name | toTitleCase if prisoner.name else "No matching name" }}, {{ prisoner.number }}</strong></li>
                                            {% if session.appointmentJourney.type == AppointmentType.BULK %}
                                                <li>{{ prisonerSchedule.startTime.hour | padNumber + ":" + prisonerSchedule.startTime.minute | padNumber }} to {{ prisonerSchedule.endTime.hour | padNumber + ":" + prisonerSchedule.endTime.minute | padNumber }}</li>
                                            {% endif %}
                                        </ul>
                                    </h2>
                                    <ul class="govuk-summary-card__actions" data-qa="schedule-card-actions-prison-number-{{ prisoner.number }}">
                                        {% if session.appointmentJourney.type == AppointmentType.BULK %}
                                            <li class="govuk-summary-card__action">
                                                <a class="govuk-link govuk-link--no-visited-state" href="review-bulk-appointment?preserveHistory=true" data-qa="change-appointment-time-prison-number-{{ prisoner.number }}">
                                                    Change time<span class="govuk-visually-hidden"> of appointment for prison number {{ prisoner.number }}</span>
                                                </a>
                                            </li>
                                            <li class="govuk-summary-card__action">
                                                <a class="govuk-link govuk-link--no-visited-state" href="{{ "schedule/" + prisoner.number + "/remove" + ("?preserveHistory=true" if preserveHistory else "") }}" data-qa="remove-appointment-prison-number-{{ prisoner.number }}">
                                                    Remove appointment<span class="govuk-visually-hidden"> for prison number {{ prisoner.number }}</span>
                                                </a>
                                            </li>
                                        {% elseif session.appointmentJourney.mode != AppointmentJourneyMode.EDIT or session.editAppointmentJourney.addPrisoners %}
                                            <li class="govuk-summary-card__action">
                                                <a class="govuk-link govuk-link--no-visited-state" href="{{ "schedule/" + prisoner.number + "/remove" + ("?preserveHistory=true" if preserveHistory else "") }}" data-qa="remove-prison-number-{{ prisoner.number }}">
                                                    Remove attendee<span class="govuk-visually-hidden"> with prison number {{ prisoner.number }}</span>
                                                </a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                                <div class="govuk-summary-card__content">
                                    {{ prisonerScheduledEvents(prisoner, prisonerSchedule.scheduledEvents) }}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}

                    {{ govukButton({
                        attributes: { 'data-qa': 'bottom-cta' },
                        text: getAppointmentEditApplyToCta(session.appointmentJourney, session.editAppointmentJourney) if isCtaAcceptAndSave else "Continue"
                    }) }}
                </form>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% macro prisonerScheduledEvents(prisoner, scheduledEvents) %}
    {% if scheduledEvents.length > 0 %}
        {% set scheduledEventRows = [] %}
        {% for scheduledEvent in scheduledEvents %}
            {% set scheduledEventRows = (scheduledEventRows.push([
                {
                    text: timeText(scheduledEvent)
                }, {
                    text: scheduledEvent.summary | trim
                }, {
                    text: eventTypeText(scheduledEvent)
                }, {
                    text: locationText(scheduledEvent)
                }
            ]), scheduledEventRows) %}
        {% endfor %}

        {{ govukTable({
            head: [
                {
                    text: "Time",
                    classes: "govuk-!-border-bottom-2",
                    attributes: { "aria-sort": "ascending" }
                }, {
                    text: "Event name",
                    attributes: { "aria-sort": "none" }
                }, {
                    text: "Type",
                    attributes: { "aria-sort": "none" }
                }, {
                    text: "Location",
                    attributes: { "aria-sort": "none" }
                }
            ],
            rows: scheduledEventRows,
            attributes: {
                'data-module': 'moj-sortable-table',
                'data-qa': 'prison-number-' + prisoner.number + '-schedule'
            }
        }) }}
    {% else %}
        <p class="govuk-body" data-qa="no-events-for-prison-number-{{ prisoner.number }}">No other events scheduled{{ '.' if session.appointmentJourney.type == AppointmentType.INDIVIDUAL }}</p>
    {% endif %}
{% endmacro %}

{% macro timeText(scheduledEvent) %}
    {% if scheduledEvent.eventType != EventType.EXTERNAL_TRANSFER and scheduledEvent.eventType != EventType.COURT_HEARING %}
        {{ scheduledEvent.startTime + (" to " + scheduledEvent.endTime if scheduledEvent.endTime) }}
    {% endif %}
{% endmacro %}

{% macro eventTypeText(scheduledEvent) %}
    {% if scheduledEvent.eventType == EventType.ACTIVITY %}
        Activity
    {% elseif scheduledEvent.eventType == EventType.APPOINTMENT %}
        Appointment
    {% elseif scheduledEvent.eventType == EventType.COURT_HEARING %}
        Court hearing
    {% elseif scheduledEvent.eventType == EventType.VISIT %}
        Visit
    {% elseif scheduledEvent.eventType == EventType.EXTERNAL_TRANSFER %}
        External transfer
    {% elseif scheduledEvent.eventType == EventType.ADJUDICATION_HEARING %}
        Adjudication hearing
    {% endif %}
{% endmacro %}

{% macro locationText(scheduledEvent) %}
    {% if scheduledEvent.eventType != EventType.EXTERNAL_TRANSFER and scheduledEvent.eventType != EventType.COURT_HEARING %}
        {% if scheduledEvent.inCell %}
            In cell
        {% elseif scheduledEvent.onWing %}
            On wing
        {% elseif scheduledEvent.offWing %}
            Off wing
        {% elseif scheduledEvent.internalLocationDescription %}
            {{ scheduledEvent.internalLocationDescription | trim }}
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro appointmentDate() %}
    {%- set startDate = session.editAppointmentJourney.startDate.date or session.appointmentJourney.startDate.date -%}
    {{ startDate | parseISODate | formatDate('EEEE, d MMMM yyyy') }}
{% endmacro %}

{% macro appointmentTime() %}
    {% set startTime = session.editAppointmentJourney.startTime.date or session.appointmentJourney.startTime.date %}
    {% set endTime = session.editAppointmentJourney.endTime.date or session.appointmentJourney.endTime.date %}
    {{ (startTime | parseISODate | formatDate('HH:mm') + ' to ' + endTime | parseISODate | formatDate('HH:mm')) }}
{% endmacro %}
