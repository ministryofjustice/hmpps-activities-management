{% extends "layout.njk" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{%- from "moj/components/search/macro.njk" import mojSearch -%}
{% from "pages/appointments/partials/appointment-type-caption.njk" import appointmentTypeCaption %}
{% from "pages/appointments/partials/appointment-journey-title.njk" import appointmentJourneyTitle %}
{% from "partials/searchInput.njk" import searchInput %}

{% set pageTitle = appointmentJourneyTitle("Select Prisoner", session.appointmentJourney) %}
{% set pageId = 'appointments-create-select-prisoner-page' %}
{% set backLinkHref = "/appointments/create/how-to-add-prisoners" if session.appointmentJourney.type == AppointmentType.GROUP else '/appointments' %}

{% set headingText = "Search and add prisoner to the appointment" %}
{% if session.appointmentJourney.type == AppointmentType.GROUP %}
    {% set headingText = "Search for an individual to add to the list of attendees" %}
{% endif %}

{% block content %}
    {{ appointmentTypeCaption(session.appointmentJourney.type) }}
    {% set defaultPrisonerNumber = formResponses.query if formResponses.query != undefined else query %}
    {% if session.appointmentJourney.type == AppointmentType.INDIVIDUAL %}
        {% set defaultPrisonerNumber = defaultPrisonerNumber or session.appointmentJourney.prisoners[0].number %}
    {% endif %}

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <h1 class="govuk-label-wrapper">
                <label class="govuk-label govuk-label--l" for="query">{{ headingText }}</label>
            </h1>
        </div>
    </div>

    {% if prisoners %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <form method="POST" action="search-prisoner{{ '?preserveHistory=true' if preserveHistory else '' }}">
                    <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
                    {{ searchInput({
                        classes: "search-input--inline-search",
                        formInputs: {
                            classes: "govuk-input--width-30"
                        },
                        input: {
                            id: "query",
                            name: "query",
                            type: "search",
                            value: defaultPrisonerNumber,
                            hint: {
                                text: 'Search by name or prison number'
                            },
                            errorMessage: validationErrors | findError("query")
                        },
                        button: {
                            text: "Search",
                            classes: "govuk-button--secondary"
                        }
                    }) }}

                    <h2 class="govuk-heading-m" id="prisoner-results-text">
                        {% if prisoners | length > 0 %}
                            Select the correct result from the list (maximum 50 results shown).
                        {% else %}
                            There are no matching search results.
                        {% endif %}
                    </h2>
                </form>
            </div>
        </div>
        {% if prisoners | length >= 1 %}
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-full">
                    <form method="POST">
                        <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
                        {% set prisonerRows = [] %}
                        {% for prisoner in prisoners %}
                            {% if prisoners | length > 1 %}
                                {% set prisonerName = '<div class="govuk-radios govuk-radios--small" data-module="govuk-radios">' +
                                                          '<div class="govuk-radios__item">' +
                                                              '<input type="radio" id="selected-prisoner-' + prisoner.prisonerNumber + '" name="selectedPrisoner" value="' + prisoner.prisonerNumber + '" class="govuk-radios__input"/>' +
                                                              '<label for="selected-prisoner-' + prisoner.prisonerNumber + '" class="govuk-label govuk-radios__label">' + prisoner | firstNameLastName | toTitleCase | prisonerName + '<label>' +
                                                          '</div>' +
                                                      '</div>'
                                %}
                            {% else %}
                                {% set prisonerName = '<input type="hidden" name="selectedPrisoner" value="' + prisoner.prisonerNumber + '"> ' + prisoner | firstNameLastName | toTitleCase | prisonerName %}
                            {% endif %}

                            {% set prisonerRows = (prisonerRows.push([
                                {
                                    attributes: {
                                        id: 'prisoner-name',
                                        "data-sort-value": prisoner | firstNameLastName | toTitleCase | prisonerName
                                    },
                                    classes: 'govuk-!-font-weight-bold',
                                    html: prisonerName
                                }, {
                                    attributes: {
                                        id: 'prisoner-number',
                                        "data-sort-value": prisoner.prisonerNumber
                                    },
                                    text: prisoner.prisonerNumber
                                }, {
                                    attributes: {
                                        id: 'prisoner-cell-location',
                                        "data-sort-value": prisoner.cellLocation
                                    },
                                    text: prisoner.cellLocation
                                }, {
                                    attributes: {
                                        id: 'prisoner-actions'
                                    },
                                    html: '<a href="' + dpsUrl + '/prisoner/' + prisoner.prisonerNumber + '" class="govuk-link govuk-link--no-visited-state" target="_blank">View <span class="govuk-visually-hidden">' + prisoner | firstNameLastName | toTitleCase + '\'s</span> prisoner profile<span class="govuk-visually-hidden"> (opens in new tab)</span></a>'
                                }
                            ]), prisonerRows) %}
                        {% endfor %}

                        {% if prisoners | length > 10 %}
                            {{ govukButton({
                                text: "Select and continue",
                                id: "continue-button-above-results"
                            }) }}
                        {% endif %}

                        {{ govukTable({
                            attributes: {
                                'data-module': 'moj-sortable-table',
                                id: 'prisoner-search-list'
                            },
                            caption: "Prisoner search list",
                            classes: "fixed-layout-table",
                            captionClasses: "govuk-visually-hidden",
                            head: [{
                                text: "Name",
                                attributes: {
                                    "aria-sort": "ascending"
                                }
                            }, {
                                text: "Prison number",
                                attributes: {
                                    "aria-sort": "none"
                                }
                            }, {
                                text: "Cell location",
                                attributes: {
                                    "aria-sort": "none"
                                }
                            }, {
                                html: '<span class="govuk-visually-hidden">Actions</span>'
                            }],
                            rows: prisonerRows
                        }) }}

                        {{ govukButton({
                            text: "Select and continue" if prisoners | length > 1 else "Continue",
                            id: "continue-button"
                        }) }}
                    </form>
                </div>
            <div>
        {% endif %}
    {% else %}
        <form method="POST" action="search-prisoner{{ '?preserveHistory=true' if preserveHistory else '' }}">
            <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    {{ searchInput({
                        input: {
                            id: "query",
                            name: "query",
                            hint: {
                                text: 'Search by name or prison number'
                            },
                            type: "search",
                            value: defaultPrisonerNumber,
                            errorMessage: validationErrors | findError("query")
                        },
                        button: {
                            text: "Search"
                        },
                        formInputs: {
                            classes: "govuk-input--width-30"
                        }
                    }) }}
                </div>
            </div>
        </form>
    {% endif %}
{% endblock %}
