{% extends "layout.njk" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "moj/components/filter/macro.njk" import mojFilter %}
{% from "components/datePicker.njk" import datePicker %}

{% from "partials/appointmentPrisonerSummary.njk" import appointmentPrisonerSummary %}
{% from "pages/appointments/partials/prisoner-list.njk" import prisonerList %}

{% set pageTitle = "Appointments Management - Appointment Search Results" %}
{% set pageId = 'appointments-search-results-page' %}
{% set backLinkHref = "/" %}

{% set categoryOptions = [{ value: "", text: "" }] %}
{% set selectedCategory = [] %}
{% for category in categories %}
    {% set categoryOptions = (categoryOptions.push( { value: category.code, text: category.description } ), categoryOptions) %}
    {% if (category.code == categoryCode) %}
        {% set selectedCategory = (selectedCategory.push({
            href: '?startDate=' + startDate | toDate | toDateString + '&endDate=' + (endDate | toDate | toDateString if endDate) + '&timeSlot=' + timeSlot + '&categoryCode=' + '&locationId=' + locationId + '&prisonerNumber=' + prisonerNumber + '&createdBy=' + createdBy + '&type=' + type,
            text: category.description
        }), selectedCategory) %}
    {% endif %}
{% endfor %}

{% set locationOptions = [{ value: "", text: "" }] %}
{% set selectedLocation = [] %}
{% for location in locations %}
    {% set locationOptions = (locationOptions.push( { value: location.id, text: location.description }), locationOptions) %}
    {% if (location.id == locationId) %}
        {% set selectedLocation = (selectedLocation.push({
            href: '?startDate=' + startDate | toDate | toDateString + '&endDate=' + (endDate | toDate | toDateString if endDate) + '&timeSlot=' + timeSlot + '&categoryCode=' + categoryCode + '&locationId=' + '&prisonerNumber=' + prisonerNumber + '&createdBy=' + createdBy + '&type=' + type,
            text: location.description
        }), selectedLocation) %}
    {% endif %}
{% endfor %}

{% block meta %}
    <meta name="autocompleteElements" content="categoryCode,locationId"/>
{% endblock %}

{% set resultsTableRows = [] %}
{% set index = 0 %}
{% for result in results %}
    {% set resultsTableRows = (resultsTableRows.push([
        {
            text: result.startDate | toDate | formatDate('d MMM yyyy'),
            attributes: { 'data-qa': 'result-date-' + index }
        }, {
            text: result.startTime + " to " + result.endTime,
            attributes: { 'data-qa': 'result-time-' + index }
        }, {
            html: govukTag({
                text: ("Individual" if result.appointmentType == AppointmentType.INDIVIDUAL) +
                ("Group" if result.appointmentType == AppointmentType.GROUP),
                classes: "govuk-tag--green"
            }) + (govukTag({ text: "Repeat" }) if result.isRepeat),
            attributes: { 'data-qa': 'result-type-' + index }
        }, {
            text: result.category.description,
            attributes: { 'data-qa': 'result-category-' + index }
        }, {
            text: result.allocations.length,
            attributes: { 'data-qa': 'result-prisoner-count-' + index }
        }, {
            text: result.internalLocation.description,
            attributes: { 'data-qa': 'result-location-' + index }
        }, {
            text: (result.sequenceNumber + " of " + result.maxSequenceNumber if result.isRepeat),
            attributes: { 'data-qa': 'result-sequence-number-' + index }
        }, {
            html: '<a href="/appointments/' + result.appointmentId + '/occurrence/' + result.appointmentOccurrenceId + '"
                class="govuk-link--no-visited-state">
                View and edit<span class="govuk-visually-hidden"> occurrence</span>
            </a>',
            classes: 'govuk-!-text-align-right',
            attributes: { 'data-qa': 'view-and-edit-result-' + index }
        }
    ]), resultsTableRows) %}
    {% set index = index + 1 %}
{% endfor %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <span class="govuk-caption-l">Appointment management</span>
            <h1 class="govuk-heading-l">View and edit an appointment</h1>
        </div>
    </div>

    {% set filterOptionsHtml %}
        {{ datePicker({
            id: 'startDate',
            name: 'startDate',
            label: {
                text: "Start date",
                classes: "govuk-label--m"
            },
            renderedErrorMessage: validationErrors | findError('startDate'),
            validationErrors: validationErrors,
            formResponses: formResponses.startDate or startDate
        }) }}

        {{ datePicker({
            id: 'endDate',
            name: 'endDate',
            label: {
                text: "End date",
                classes: "govuk-label--m"
            },
            renderedErrorMessage: validationErrors | findError('endDate'),
            validationErrors: validationErrors,
            formResponses: formResponses.endDate or endDate
        }) }}

        {{ govukRadios({
            name: "timeSlot",
            fieldset: {
                legend: {
                    text: "Time period",
                    classes: "govuk-fieldset__legend--m"
                }
            },
            errorMessage: validationErrors | findError('timeSlot'),
            items: [
                {
                    value: TimeSlot.AM,
                    text: "Morning (AM)",
                    checked: (formResponses.timeSlot or timeSlot) == TimeSlot.AM
                },
                {
                    value: TimeSlot.PM,
                    text: "Afternoon (PM)",
                    checked: (formResponses.timeSlot or timeSlot) == TimeSlot.PM
                },
                {
                    value: TimeSlot.ED,
                    text: "Evening (ED)",
                    checked: (formResponses.timeSlot or timeSlot) == TimeSlot.ED
                }
            ]
        }) }}

        {{ govukSelect({
            id: "categoryCode",
            name: "categoryCode",
            label: {
                text: "Category",
                classes: "govuk-label--m"
            },
            errorMessage: validationErrors | findError('categoryCode'),
            items: categoryOptions,
            value: formResponses.categoryCode or categoryCode
        }) }}

        {{ govukSelect({
            id: "locationId",
            name: "locationId",
            label: {
                text: "Location",
                classes: "govuk-label--m"
            },
            errorMessage: validationErrors | findError('locationId'),
            items: locationOptions,
            value: formResponses.locationId or locationId
        }) }}

        {{ govukInput({
            id: "prisonerNumber",
            name: "prisonerNumber",
            label: {
                text: "Prisoner number",
                classes: "govuk-label--m"
            },
            spellcheck: false,
            errorMessage: validationErrors | findError('prisonerNumber'),
            value: formResponses.prisonerNumber or prisonerNumber,
            type: 'search'
        }) }}

        {{ govukRadios({
            name: "createdBy",
            fieldset: {
                legend: {
                    text: "Created by",
                    classes: "govuk-fieldset__legend--m"
                }
            },
            errorMessage: validationErrors | findError('createdBy'),
            items: [
                {
                    value: user.username,
                    text: "Myself",
                    checked: (formResponses.createdBy or createdBy) == user.username
                },
                {
                    value: "all",
                    text: "All appointment creators",
                    checked: (formResponses.timeSlot or timeSlot) == "all"
                }
            ]
        }) }}

        {{ govukRadios({
            name: "type",
            fieldset: {
                legend: {
                    text: "Type",
                    classes: "govuk-fieldset__legend--m"
                }
            },
            errorMessage: validationErrors | findError('type'),
            items: [
                {
                    value: AppointmentType.INDIVIDUAL,
                    text: "Individual appointment",
                    checked: (formResponses.type or type) == AppointmentType.INDIVIDUAL
                },
                {
                    value: AppointmentType.GROUP,
                    text: "Group appointment",
                    checked: (formResponses.type or type) == AppointmentType.GROUP
                }
            ]
        }) }}

        <button class="govuk-button govuk-!-margin-top-7" data-module="govuk-button">
            Apply filters
        </button>
    {% endset %}

    {% set selectedEndDate = [] %}
    {% if (endDate) %}
        {% set selectedEndDate = (selectedEndDate.push({
            href: '?startDate=' + startDate | toDate | toDateString + '&endDate=' + '&timeSlot=' + timeSlot + '&categoryCode=' + categoryCode + '&locationId=' + locationId + '&prisonerNumber=' + prisonerNumber + '&createdBy=' + createdBy + '&type=' + type,
            text: endDate | toDate | formatDate('d MMM yyyy')
        }), selectedEndDate) %}
    {% endif %}

    {% set selectedTimeSlot = [] %}
    {% if (timeSlot) %}
        {% set selectedTimeSlot = (selectedTimeSlot.push({
            href: '?startDate=' + startDate | toDate | toDateString + '&endDate=' + (endDate | toDate | toDateString if endDate) + '&timeSlot=' + '&categoryCode=' + categoryCode + '&locationId=' + locationId + '&prisonerNumber=' + prisonerNumber + '&createdBy=' + createdBy + '&type=' + type,
            text: ("Morning (AM)" if timeSlot == TimeSlot.AM) +
                  ("Afternoon (PM)" if timeSlot == TimeSlot.PM) +
                  ("Evening (ED)" if timeSlot == TimeSlot.ED)
        }), selectedTimeSlot) %}
    {% endif %}

    {% set selectedPrisonerNumber = [] %}
    {% if (prisonerNumber) %}
        {% set selectedPrisonerNumber = (selectedPrisonerNumber.push({
            href: '?startDate=' + startDate | toDate | toDateString + '&endDate=' + (endDate | toDate | toDateString if endDate) + '&timeSlot=' + timeSlot + '&categoryCode=' + categoryCode + '&locationId=' + locationId + '&prisonerNumber=' + '&createdBy=' + createdBy + '&type=' + type,
            text: prisonerNumber
        }), selectedTimeSlot) %}
    {% endif %}

    {% set selectedCreatedBy = [] %}
    {% if (createdBy) %}
        {% set selectedCreatedBy = (selectedCreatedBy.push({
            href: '?startDate=' + startDate | toDate | toDateString + '&endDate=' + (endDate | toDate | toDateString if endDate) + '&timeSlot=' + timeSlot + '&categoryCode=' + categoryCode + '&locationId=' + locationId + '&prisonerNumber=' + prisonerNumber + '&createdBy=' + '&type=' + type,
            text: ("Myself" if createdBy == user.username) +
                  ("All appointment creators" if createdBy == "all")
        }), selectedCreatedBy) %}
    {% endif %}

    {% set selectedType = [] %}
    {% if (type) %}
        {% set selectedType = (selectedType.push({
            href: '?startDate=' + startDate | toDate | toDateString + '&endDate=' + (endDate | toDate | toDateString if endDate) + '&timeSlot=' + timeSlot + '&categoryCode=' + categoryCode + '&locationId=' + locationId + '&prisonerNumber=' + prisonerNumber + '&createdBy=' + createdBy + '&type=',
            text: ("Individual appointment" if type == AppointmentType.INDIVIDUAL) +
                  ("Group appointment" if type == AppointmentType.GROUP)
        }), selectedType) %}
    {% endif %}

    <div class="moj-filter-layout" data-module="activities-list-filter" data-filter-start-shown="true">
        <div class="moj-filter-layout__filter govuk-!-display-none-print">
            <form method="POST">
                <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
                {{ mojFilter({
                    heading: {
                        text: 'Filter'
                    },
                    selectedFilters: {
                        heading: {
                            text: 'Selected filters'
                        },
                        clearLink: {
                            text: 'Clear filters',
                            href: '?startDate=' + now | toDateString
                        },
                        categories: [
                            {
                                heading: {
                                    text: 'End date'
                                },
                                items: selectedEndDate
                            },
                            {
                                heading: {
                                    text: 'Time period'
                                },
                                items: selectedTimeSlot
                            },
                            {
                                heading: {
                                    text: 'Category'
                                },
                                items: selectedCategory
                            },
                            {
                                heading: {
                                    text: 'Location'
                                },
                                items: selectedLocation
                            },
                            {
                                heading: {
                                    text: 'Prisoner number'
                                },
                                items: selectedPrisonerNumber
                            },
                            {
                                heading: {
                                    text: 'Created by'
                                },
                                items: selectedCreatedBy
                            },
                            {
                                heading: {
                                    text: 'Type'
                                },
                                items: selectedType
                            }
                        ]
                    },
                    optionsHtml: filterOptionsHtml
                }) }}
            </form>
        </div>
        <div class="moj-filter-layout__content">
            <div class="moj-action-bar govuk-!-display-none-print">
                <div class="moj-action-bar__filter"></div>
            </div>

            {{ govukTable({
                attributes: {
                    'data-module': 'moj-sortable-table',
                    'data-qa': 'search-results'
                },
                caption: "Appointments",
                head: [{
                    text: "Date",
                    attributes: { "aria-sort": "none" }
                },
                {
                    text: "Time",
                    attributes: { "aria-sort": "ascending" }
                },
                {
                    text: "Type"
                },
                {
                    text: "Category",
                    attributes: { "aria-sort": "none" }
                },
                {
                    text: "Prisoners",
                    attributes: { "aria-sort": "none" }
                },
                {
                    text: "Location",
                    attributes: { "aria-sort": "none" }
                },
                {
                    text: "Occurrence",
                    attributes: { "aria-sort": "none" }
                },
                {
                    html: '<span class="govuk-visually-hidden">Actions</span>'
                }],
                rows: resultsTableRows
            }) }}
        </div>
    </div>
{% endblock %}
