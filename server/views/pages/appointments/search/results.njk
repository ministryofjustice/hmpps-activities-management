{% extends "layout.njk" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "moj/components/filter/macro.njk" import mojFilter %}
{% from "components/datePicker.njk" import datePicker %}
{% from "partials/showProfileLink.njk" import showProfileLink %}

{% set pageTitle = "Appointments Management - Appointment Search Results" %}
{% set pageId = 'appointments-search-results-page' %}
{% set backLinkText = "Choose a different date" %}
{% set backLinkHref = "/appointments/search/select-date" %}

{% macro attendees(allocations) %}
    {% if allocations | length == 1 %}
        {% set prisonerDetails = prisonersDetails[allocations[0].prisonerNumber] %}
        {{ showProfileLink({
            name: prisonerDetails.firstName + " " + prisonerDetails.lastName,
            prisonerNumber: prisonerDetails.prisonerNumber,
            cellLocation: prisonerDetails.cellLocation or "N/A",
            link: true,
            classes: 'hmpps-inline-block'
        }) }}
    {% else %}
        {{ allocations.length }}
    {% endif %}
{% endmacro %}

{% macro appointmentResultActions(result) %}
    {% if result.isCancelled %}
        <div class="govuk-!-margin-bottom-1">
            {{ govukTag({
                text: 'Cancelled',
                classes: "govuk-tag--red"
            })}}
        </div>
    {% endif %}

    <a href="/appointments/{{ result.appointmentId }}/occurrence/{{ result.appointmentOccurrenceId }}" class="govuk-link--no-visited-state">
        View{{ " and manage" if not result.isExpired and not result.isCancelled }} <span class="govuk-visually-hidden"> appointment</span>
    </a>
{% endmacro %}

{% set resultsTableRows = [] %}
{% set index = 0 %}
{% for result in results %}
    {% set resultsTableRows = (resultsTableRows.push([
        {
            text: result.startTime + (" to " + result.endTime if result.endTime),
            attributes: { 'data-qa': 'result-time-' + index }
        }, {
            text: result.appointmentName,
            attributes: { 'data-qa': 'result-appointment-name-' + index }
        }, {
            text: result.internalLocation.description,
            attributes: { 'data-qa': 'result-location-' + index }
        }, {
            html: attendees(result.allocations, prisonersDetails),
            attributes: { 'data-qa': 'result-prisoner-count-' + index }
        }, {
            text: result.sequenceNumber + " of " + result.maxSequenceNumber,
            classes: 'govuk-!-text-align-right',
            attributes: { 'data-qa': 'result-sequence-number-' + index }
        }, {
            html: appointmentResultActions(result),
            classes: 'govuk-!-text-align-right',
            attributes: { 'data-qa': 'view-and-edit-result-' + index }
        }
    ]), resultsTableRows) %}
    {% set index = index + 1 %}
{% endfor %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <h1 class="govuk-heading-l govuk-!-margin-0">Appointments dashboard</h1>
            <span class="govuk-caption-l govuk-!-margin-bottom-3" data-qa="start-date-caption">{{ startDate | toDate | formatDate('EEEE, dd MMMM yyyy') }}</span>
            <p class="govuk-body">Select an appointment to manage details, including printing movement slips, changing location and date, and removing people or cancelling.</p>
            <p class="govuk-body govuk-!-margin-bottom-6">You can't change details of appointments that have already taken place.</p>
        </div>
    </div>

    {% set selectedFilterCategories = [] %}

    {% set selectedDateAndTime = [] %}
    {% if (timeSlot) %}
        {% set selectedDateAndTime = (selectedDateAndTime.push({
            href: '?startDate=' + startDate | toDate | toDateString + '&timeSlot=' + '&categoryCode=' + categoryCode + '&locationId=' + locationId + '&prisonerNumber=' + prisonerNumber + '&createdBy=' + createdBy,
            text: ("Morning (AM)" if timeSlot == TimeSlot.AM) +
                  ("Afternoon (PM)" if timeSlot == TimeSlot.PM) +
                  ("Evening (ED)" if timeSlot == TimeSlot.ED)
        }), selectedDateAndTime) %}
    {% endif %}

    {% if (selectedDateAndTime.length > 0) %}
        {% set selectedFilterCategories = (selectedFilterCategories.push({
            heading: {
                text: 'Time period'
            },
            items: selectedDateAndTime
        }), selectedFilterCategories) %}
    {% endif %}

    {% set categoryOptions = [{ value: "", text: "" }] %}
    {% for category in categories %}
        {% set categoryOptions = (categoryOptions.push( { value: category.code, text: category.description } ), categoryOptions) %}
        {% if (category.code == categoryCode) %}
            {% set selectedFilterCategories = (selectedFilterCategories.push({
                heading: {
                    text: 'Appointment name'
                },
                items: [{
                    href: '?startDate=' + startDate | toDate | toDateString + '&timeSlot=' + timeSlot + '&categoryCode=' + '&locationId=' + locationId + '&prisonerNumber=' + prisonerNumber + '&createdBy=' + createdBy,
                    text: category.description
                }]
            }), selectedFilterCategories) %}
        {% endif %}
    {% endfor %}

    {% set locationOptions = [{ value: "", text: "" }] %}
    {% for location in locations %}
        {% set locationOptions = (locationOptions.push( { value: location.id, text: location.description }), locationOptions) %}
        {% if (location.id == locationId) %}
            {% set selectedFilterCategories = (selectedFilterCategories.push({
                heading: {
                    text: 'Location'
                },
                items: [{
                    href: '?startDate=' + startDate | toDate | toDateString + '&timeSlot=' + timeSlot + '&categoryCode=' + categoryCode + '&locationId=' + '&prisonerNumber=' + prisonerNumber + '&createdBy=' + createdBy,
                    text: location.description
                }]
            }), selectedFilterCategories) %}
        {% endif %}
    {% endfor %}

    {% if (prisonerNumber) %}
        {% set selectedFilterCategories = (selectedFilterCategories.push({
            heading: {
                text: 'Prison number'
            },
            items: [{
                href: '?startDate=' + startDate | toDate | toDateString + '&timeSlot=' + timeSlot + '&categoryCode=' + categoryCode + '&locationId=' + locationId + '&prisonerNumber=' + '&createdBy=' + createdBy,
                text: prisonerNumber
            }]
        }), selectedFilterCategories) %}
    {% endif %}

    {% if (createdBy) %}
        {% set selectedFilterCategories = (selectedFilterCategories.push({
            heading: {
                text: 'Created by'
            },
            items: [{
                href: '?startDate=' + startDate | toDate | toDateString + '&timeSlot=' + timeSlot + '&categoryCode=' + categoryCode + '&locationId=' + locationId + '&prisonerNumber=' + prisonerNumber + '&createdBy=',
                text: ("Myself" if createdBy == user.username) +
                ("All appointment creators" if createdBy == "all")
            }]
        }), selectedFilterCategories) %}
    {% endif %}

    {% if (selectedFilterCategories.length > 0) %}
        {% set selectedFilters = {
            heading: {
                text: 'Selected filters'
            },
            clearLink: {
                text: 'Clear filters',
                href: '?startDate=' + startDate | toDate | toDateString
            },
            categories: selectedFilterCategories
        } %}
    {% endif %}

    {% set filterOptionsHtml %}
        {{ datePicker({
            id: 'startDate',
            name: 'startDate',
            label: {
                text: "Date",
                classes: "govuk-label--s"
            },
            renderedErrorMessage: validationErrors | findError('startDate'),
            validationErrors: validationErrors,
            formResponses: formResponses.startDate or startDate
        }) }}

        {{ govukRadios({
            name: "timeSlot",
            classes: "govuk-radios--small",
            fieldset: {
                legend: {
                    text: "Time period",
                    classes: "govuk-fieldset__legend--s"
                }
            },
            errorMessage: validationErrors | findError('timeSlot'),
            items: [
                {
                    value: TimeSlot.AM,
                    text: "Morning (AM)",
                    checked: (formResponses.timeSlot or timeSlot) == TimeSlot.AM
                },
                {
                    value: TimeSlot.PM,
                    text: "Afternoon (PM)",
                    checked: (formResponses.timeSlot or timeSlot) == TimeSlot.PM
                },
                {
                    value: TimeSlot.ED,
                    text: "Evening (ED)",
                    checked: (formResponses.timeSlot or timeSlot) == TimeSlot.ED
                }
            ]
        }) }}

        {{ govukSelect({
            id: "categoryCode",
            name: "categoryCode",
            label: {
                text: "Appointment name",
                classes: "govuk-label--s"
            },
            errorMessage: validationErrors | findError('categoryCode'),
            items: categoryOptions,
            value: formResponses.categoryCode or categoryCode
        }) }}

        {{ govukSelect({
            id: "locationId",
            name: "locationId",
            label: {
                text: "Location",
                classes: "govuk-label--s"
            },
            errorMessage: validationErrors | findError('locationId'),
            items: locationOptions,
            value: formResponses.locationId or locationId
        }) }}

        {{ govukInput({
            id: "prisonerNumber",
            name: "prisonerNumber",
            label: {
                text: "Prison number",
                classes: "govuk-label--s"
            },
            spellcheck: false,
            errorMessage: validationErrors | findError('prisonerNumber'),
            value: formResponses.prisonerNumber or prisonerNumber,
            type: 'search'
        }) }}

        {{ govukRadios({
            name: "createdBy",
            classes: "govuk-radios--small",
            fieldset: {
                legend: {
                    text: "Created by",
                    classes: "govuk-fieldset__legend--s"
                }
            },
            errorMessage: validationErrors | findError('createdBy'),
            items: [
                {
                    value: user.username,
                    text: "Myself",
                    checked: (formResponses.createdBy or createdBy) == user.username
                },
                {
                    value: "all",
                    text: "All appointment creators",
                    checked: (formResponses.createdBy or createdBy) == "all"
                }
            ]
        }) }}

        <button class="govuk-button govuk-!-margin-top-7" data-module="govuk-button">
            Apply filters
        </button>
    {% endset %}

    <div class="moj-filter-layout" data-module="activities-list-filter" data-filter-start-shown="true">
        <div class="moj-filter-layout__filter govuk-!-display-none-print">
            <form method="POST">
                <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
                {{ mojFilter({
                    heading: {
                        text: 'Filter'
                    },
                    selectedFilters: selectedFilters,
                    optionsHtml: filterOptionsHtml
                }) }}
            </form>
        </div>
        <div class="moj-filter-layout__content">
            <div class="moj-action-bar govuk-!-display-none-print">
                <div class="moj-action-bar__filter"></div>
            </div>

            {{ govukTable({
                attributes: {
                    'data-module': 'moj-sortable-table',
                    'data-qa': 'search-results'
                },
                caption: "Showing " + results | length + " appointment" + ("s" if results | length != 1),
                head: [
                {
                    text: "Time",
                    attributes: { "aria-sort": "none" }
                },
                {
                    text: "Appointment name",
                    attributes: { "aria-sort": "none" }
                },
                {
                    text: "Location",
                    attributes: { "aria-sort": "none" }
                },
                {
                    text: "Attendees",
                    attributes: { "aria-sort": "none" }
                },
                {
                    text: "Appointment",
                    attributes: { "aria-sort": "none" }
                },
                {
                    html: '<span class="govuk-visually-hidden">Actions</span>'
                }],
                rows: resultsTableRows
            }) }}
        </div>
    </div>
{% endblock %}

{% block meta %}
    <meta name="autocompleteElements" content="categoryCode,locationId"/>
{% endblock %}
