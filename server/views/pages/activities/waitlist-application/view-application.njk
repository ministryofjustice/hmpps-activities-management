{% extends "layout.njk" %}

{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "partials/activities/waitlist-status-badge.njk" import waitlistStatusBadge %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "moj/components/timeline/macro.njk" import mojTimeline %}

{% set pageTitle = "View waitlist application - Activities - DPS" %}
{% set pageId = 'view-application-page' %}
{% set jsBackLink = true %}

{% set editable = 'ROLE_ACTIVITY_HUB' in user.roles and isMostRecent and isNotAlreadyAllocated %}

{% block content %}
    {% if not isNotAlreadyAllocated %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                {{ govukNotificationBanner({
                    html: '
                        <p class="govuk-notification-banner__heading">
                            You cannot edit this application because the prisoner has already been allocated to the activity
                        </p>
                      '
                }) }}
            </div>
        </div>
    {% elseif not isMostRecent %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                {{ govukNotificationBanner({
                    html: '
                        <p class="govuk-notification-banner__heading">
                            You cannot edit this application because there is a more recent application for this prisoner
                        </p>
                      '
                }) }}
            </div>
        </div>
    {% endif %}

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <span class="govuk-caption-xl">{{ waitListApplicationJourney.activity.activityName }}</span>
        </div>
    </div>
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">

            <h1 class='govuk-heading-l'>Request for {{ prisoner.name }}, {{ prisoner.prisonerNumber }}</h1>

            {% set applicationDetailsHtml %}
                {% if waitlistWithdrawnEnabled and status == 'WITHDRAWN' %}
                    {% set applicationAction = {
                        href: "reinstate?preserveHistory=true",
                        text: "Reinstate",
                        visuallyHiddenText: " application"
                    } %}
                {% else %}
                    {% set applicationAction = {
                        href: "status?preserveHistory=true",
                        text: "Change",
                        visuallyHiddenText: "status"
                    } %}
                {% endif %}
                {{ govukSummaryList({
                    rows: [
                        {
                            key: {
                                text: "Status"
                            },
                            value: {
                                html:   waitlistStatusBadge(status, waitlistWithdrawnEnabled) +
                                        (('<div class="govuk-!-font-size-16 govuk-hint govuk-!-margin-top-2">Last changed ' + statusUpdatedTime | parseISODate | formatDate('do MMMM yyyy HH:mm') + '</div>') if statusUpdatedTime)
                            },
                            actions: {
                                items: [
                                    applicationAction
                                ]
                            } if editable
                        },
                        {
                            key: {
                                text: "Activity requested"
                            },
                            value: {
                                text: activityName
                            }
                        },
                        {
                            key: {
                                text: "Requester"
                            },
                            value: {
                                text: requester
                            },
                            actions: {
                                items: [
                                    {
                                        href: "requester?preserveHistory=true",
                                        text: "Change",
                                        visuallyHiddenText: "requester"
                                    }
                                ]
                            } if editable
                        },
                        {
                            key: {
                                text: "Date of request"
                            },
                            value: {
                                text: requestDate | formatDate('do MMMM yyyy')
                            },
                            actions: {
                                items: [
                                    {
                                        href: "request-date?preserveHistory=true",
                                        text: "Change",
                                        visuallyHiddenText: "request date"
                                    }
                                ]
                            } if editable
                        },
                        {
                            key: {
                                text: "Comments"
                            },
                            value: {
                                text: comment or "None"
                            },
                            actions: {
                                items: [
                                    {
                                        href: "comment?preserveHistory=true",
                                        text: "Change",
                                        visuallyHiddenText: "comment"
                                    }
                                ]
                            } if editable
                        }
                    ]
                }) }}

                <div class="govuk-button-group">
                    {% if journeyEntry and journeyEntry.includes('prisoner-allocations') %}
                        {% set buttonText = "Return to " + prisoner.name | possessive + " applications" %}
                        {% set href = journeyEntry %}
                    {% elseif journeyEntry and journeyEntry.includes('waitlist-dashboard') %}
                        {% set buttonText = "Return to applications" %}
                        {% set href = '/activities/waitlist-dashboard' %}
                    {% else %}
                        {% set buttonText = "Return to waitlist" %}
                        {% set href = '/activities/allocation-dashboard/' + activityId + '#waitlist-tab' %}
                    {% endif %}

                    {{ govukButton({
                        text: buttonText,
                        href: href,
                        classes: "govuk-button--secondary"
                    }) }}
                </div>
            {% endset %}

            {% if waitlistWithdrawnEnabled %}
                {% set applicationHistoryHtml %}
                {% if history.length == 0 %}
                    <p class="govuk-body">There is no history for this application.</p>
                {% else %}
                    {% set rows = [] %}
                    {% for historyItem in history %}
                        {% set rows = (rows.push({
                            label: {
                                text: historyItem.change
                            },
                            html: historyItem.note,
                            datetime: {
                                timestamp: historyItem.updatedDateTime,
                                format: 'DD MMMM YYYY HH:mm'
                            },
                            byline: {
                                text: historyItem.updatedBy
                            }
                        }), rows) %}
                    {% endfor %}
                    {{ mojTimeline({
                        items: rows
                    }) }}
                    {% if createdAppPreHistory == true %}
                        <h2 class='govuk-heading-m'>About applications logged before December 2025</h2>
                        <p class="govuk-body">Changes made before December 2025 cannot be shown. This history may not be complete.</p>
                    {% endif %}    
                {% endif %}
                {% endset %}
                <div class="govuk-!-margin-bottom-6">
                    {{ govukTabs({
                    classes: "govuk-tabs--borderless",
                    items: [
                        {
                            label: "Application details",
                            id: "details-tab",
                            panel: {
                                html: applicationDetailsHtml
                            }
                        },
                        {
                            label: "Application history",
                            id: "history-tab",
                            panel: {
                                html: applicationHistoryHtml
                            }
                        }
                    ]
                }) }}
                </div>
            {% else %}
                {{ applicationDetailsHtml | safe }}
            {% endif %}

        </div>
    </div>
{% endblock %}
