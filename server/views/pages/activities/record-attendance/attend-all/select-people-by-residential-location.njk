{% extends "layout.njk" %}

{% from "partials/attendance/attendanceRowsTableWithStickySelect.njk" import attendanceRowsTableWithStickySelect %}
{% from "moj/components/filter/macro.njk" import mojFilter %}
{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/accordion/macro.njk" import govukAccordion %}

{% set pageTitle = applicationName + " - Select people by residential location" %}
{% set pageId = 'select-people-by-residential-location-page' %}
{% set hardBackLinkText = 'Back' %}
{% set hardBackLinkHref = "choose-details-by-residential-location" %}

{% set displayDate = activityDate | formatDate %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <h1 class="govuk-heading-xl govuk-!-margin-bottom-4">
                <span class="govuk-caption-l">Record activity attendance <span class="govuk-visually-hidden">for</span></span>
                {{ location.name }} - record or edit activity attendance
                <span class="govuk-caption-l">{{ displayDate }} - {{ timePeriodFilter }}</span>
            </h1>

            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                  <a href="../attend-all/choose-details-by-residential-location" class="govuk-link govuk-!-font-size-19">Select a different day, time period or location</a>
                    <h2 class="govuk-heading-m govuk-!-margin-top-4">{{ totalAttendees }}
                        {{ "person" if totalAttendees | length == 1 else "people" }} allocated to activities</h2>
                </div>
            </div>
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
              <p class="govuk-!-margin-bottom-0">Sessions people are allocated to: <strong>{{ totalAttendanceRecords }}</strong></p>
              <p class="govuk-!-margin-bottom-0">Attended: <strong>{{ totalAttended }}</strong></p>
              <p class="govuk-!-margin-bottom-0">Absences: <strong>{{ totalAbsences }}</strong></p>
              <p class="govuk-!-margin-bottom-0">Not recorded: <strong>{{ totalNotRecorded }}</strong></p>
            </div>
          </div>
            <div class="govuk-grid-row govuk-!-margin-bottom-4">
                <div class="govuk-grid-column-two-thirds">
                    <div class="search-input search-input--inline-search govuk-!-margin-top-6 govuk-!-display-none-print">
                        <div class="search-input__form-inputs">
                            <div class="govuk-form-group">
                                <label class="govuk-label govuk-label--s" for="searchTerm">Search by name or prison number, or event name</label>
                                <input class="govuk-input" id="searchTerm" name="searchTerm" type="search" form="filter-form" value="{{ recordAttendanceJourney.searchTerm }}">
                            </div>
                            <button type="submit" class="govuk-button" data-module="govuk-button" form="filter-form">Search</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="govuk-grid-column-full">
            <div class="moj-filter-layout moj-filter-layout__flex" data-module="activities-list-filter">
                <div class="moj-filter-layout__filter moj-filter-layout__flex govuk-!-display-none-print">
                    <form id="filter-form" method="POST" action="update-filters" novalidate>
                        <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
                        {% set residentialLocation %}
                            {% if location.children | length %}
                                {% set locationFilters = [] %}
                                {% for subLocation in location.children %}
                                    {% set locationFilters = (locationFilters.push({value: subLocation.key, text: subLocation.name, checked: subLocation.key in recordAttendanceJourney.subLocationFilters}), locationFilters) %}
                                {% endfor %}

                                {{ govukCheckboxes({
                                    formGroup: {
                                        classes: "govuk-!-margin-bottom-2"
                                    },
                                    idPrefix: 'locationFilters',
                                    name: 'locationFilters',
                                    classes: "govuk-checkboxes--small",
                                    fieldset: {
                                        legend: {
                                            text: 'Residential location',
                                            classes: 'govuk-visually-hidden'
                                        }
                                    },
                                    items: locationFilters
                                    }) }}
                                <div>
                                    <a href="#" class="govuk-link govuk-link--no-visited-state" data-module="select-all-link" data-checkbox-name="locationFilters"></a>
                                </div>
                            {% endif %}
                        {% endset %}

                        {% set accordionFilterItems = [] %}
                        {% if location.children | length %}
                            {% set accordionFilterItems = (accordionFilterItems.push({
                                heading: {
                                    text: "Residential location"
                                },
                                content: {
                                    html: residentialLocation
                                },
                                expanded: true
                            }), accordionFilterItems) %}
                        {% endif %}
                        {% set filterOptionsHtml %}
                        {{ govukAccordion({
                                id: "filter-accordion",
                                items: accordionFilterItems
                            }) }}
                        <button class="govuk-button govuk-!-margin-top-3 govuk-!-margin-bottom-3" data-module="govuk-button">Apply filters</button>
                        {% endset %}


                        {{ mojFilter({
                            heading: {
                                text: 'Filters'
                            },
                            attributes: {
                                'data-filter-start-shown': 'true'
                            },
                            optionsHtml: filterOptionsHtml
                        }) }}
                    </form>
                </div>
                <div class="moj-filter-layout__content">
                    <div class="moj-action-bar govuk-!-display-none-print">
                        <div class="moj-action-bar__filter"></div>
                    </div>
                    <form method='POST' data-module="form-spinner" data-loading-text="Marking attendance">
                        <input type="hidden" name="_csrf" value="{{ csrfToken }}">
                        {{ attendanceRowsTableWithStickySelect(attendanceRows, instance, user.activeCaseLoadId, true, false, user.roles,'select-people-by-residential-location/') }}
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
